<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>1.12</version>

<file name="$boarddir/index.php">
	<operation>
		<search position="before"><![CDATA['suggest' => array('Subs-Editor.php', 'AutoSuggestHandler'),]]></search>
		<add><![CDATA[// Split Forums Mod
		'subforums' => array('ManageSplitForums.php', 'ManageSplitForums'),
		]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- SSI functions modified to work with subforums (SSI.php)              -->
<!-------------------------------------------------------------------------->
<file name="$boarddir/SSI.php">
	<!-- ssi_queryPosts function -->
	<operation>
		<search position="before"><![CDATA[function ssi_queryPosts($query_where = '', $query_where_params = array(), $query_limit = 10, $query_order = 'm.id_msg DESC', $output_method = 'echo', $limit_body = false, $override_permissions = false)
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[WHERE 1=1 ' . ($override_permissions ? '' : ']]></search>
		<add><![CDATA[WHERE c.forumid = {int:forumid} ' . ($override_permissions ? '' : ']]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_recentTopics function -->
	<operation>
		<search position="before"><![CDATA[function ssi_recentTopics($num_recent = 8, $exclude_boards = null, $include_boards = null, $output_method = 'echo')
{
	global $context, $settings, $scripturl, $txt, $db_prefix, $user_info]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_last_msg)
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE t.id_last_msg >= {int:min_message_id}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'include_boards' => empty($include_boards) ? '' : $include_boards,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_topBoards function -->
	<operation>
		<search position="before"><![CDATA[function ssi_topBoards($num_top = 10, $output_method = 'echo')
{
	global $context, $settings, $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[LEFT JOIN {db_prefix}log_boards AS lb ON (lb.id_board = b.id_board AND lb.id_member = {int:current_member})]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND b.id_board != {int:recycle_board}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_member' => $user_info['id'],
			'recycle_board' => (int) $modSettings['recycle_board'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_topTopics function -->
	<operation>
		<search position="before"><![CDATA[global $db_prefix, $txt, $scripturl, $user_info, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_topic
			FROM {db_prefix}topics
			WHERE num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND approved = {int:is_approved}' : '') . '
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(
				'is_approved' => 1,
				'limit' => $num_topics > 100 ? ($num_topics + ($num_topics / 2)) : 100,
			)]]></search>
		<add><![CDATA[SELECT t.id_topic
			FROM {db_prefix}topics AS t
				INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE t.num_' . ($type != 'replies' ? 'views' : 'replies') . ' != 0' . ($modSettings['postmod_active'] ? '
				AND t.approved = {int:is_approved}' : '') . '
				AND c.forumid = {int:forumid}
			ORDER BY num_' . ($type != 'replies' ? 'views' : 'replies') . ' DESC
			LIMIT {int:limit}',
			array(
				'is_approved' => 1,
				'limit' => $num_topics > 100 ? ($num_topics + ($num_topics / 2)) : 100,
				'forumid' => (int) $forumid,
			)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS m ON (m.id_msg = t.id_first_msg)
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND t.id_topic IN ({array_int:topic_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['recycle_enable' => $modSettings['recycle_board'],
			'limit' => $num_topics,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_boardStats function -->
	<operation>
		<search position="before"><![CDATA[global $db_prefix, $txt, $scripturl, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$totals = array(
		'members' => $modSettings['totalMembers'],
		'posts' => $modSettings['totalMessages'],
		'topics' => $modSettings['totalTopics']
	);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}boards',
		array(
		)
	);
	list ($totals['boards']) = $smcFunc['db_fetch_row']($result);
	$smcFunc['db_free_result']($result);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories',
		array(
		)]]></search>
		<add><![CDATA[$result = $smcFunc['db_query']('', '
		SELECT COUNT(b.id_board) AS boards, SUM(b.num_topics) AS topics, SUM(b.num_posts) AS posts
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
		)
	);
	$row = $smcFunc['db_fetch_assoc']($result);
	$totals = array(
		'members' => $modSettings['totalMembers'],
		'boards' => $row['boards'],
		'topics' => $row['topics'],
		'posts' => $row['posts'],
	);
	$smcFunc['db_free_result']($result);

	$result = $smcFunc['db_query']('', '
		SELECT COUNT(*)
		FROM {db_prefix}categories AS c
		WHERE c.forumid = {int:forumid}',
		array(
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	
	<!-- ssi_recentPoll function -->
	<operation>
		<search position="before"><![CDATA[function ssi_recentPoll($topPollInstead = false, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)' . ($topPollInstead ? ']]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' . ($topPollInstead ? ']]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND b.id_board IN ({array_int:boards_allowed_list})' : '') . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
			AND b.id_board != {int:recycle_enable}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_time' => time(),
			'recycle_enable' => $modSettings['recycle_board'],]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_showPoll function -->
	<operation>
		<search position="before"><![CDATA[function ssi_showPoll($topic = null, $output_method = 'echo')
{
	global $db_prefix, $txt, $settings, $boardurl, $user_info, $context, $smcFunc, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
		WHERE t.id_topic = {int:current_topic}]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE t.id_topic = {int:current_topic}
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['boards_allowed_see' => $boardsAllowed,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_pollVote function -->
	<operation>
		<search position="before"><![CDATA[function ssi_pollVote()
{
	global $context, $db_prefix, $user_info, $sc, $smcFunc, $sourcedir, $modSettings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_poll = {int:current_poll})
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE p.id_poll = {int:current_poll}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['current_poll' => $_POST['poll'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => (int) $forumid,]]></add>
	</operation>
	
	<!-- ssi_boardNews function -->
	<operation>
		<search position="before"><![CDATA[global $scripturl, $db_prefix, $txt, $settings, $modSettings, $context]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board
		FROM {db_prefix}boards
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
		LIMIT 1',
		array(
			'current_board' => $board,
		)]]></search>
		<add><![CDATA[SELECT b.id_board
		FROM {db_prefix}boards AS b
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		WHERE ' . ($board === null ? '' : 'id_board = {int:current_board}
			AND ') . 'FIND_IN_SET(-1, member_groups) != 0
			AND c.forumid = {int:forumid}
		LIMIT 1',
		array(
			'current_board' => $board,
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT t.id_first_msg
		FROM {db_prefix}topics as t
		LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(
			'current_board' => $board,
			'is_approved' => 1,
		)]]></search>
		<add><![CDATA[SELECT t.id_first_msg
		FROM {db_prefix}topics as t
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			LEFT JOIN {db_prefix}boards as b ON (b.id_board = t.id_board)
		WHERE t.id_board = {int:current_board}' . ($modSettings['postmod_active'] ? '
			AND t.approved = {int:is_approved}' : '') . '
			AND {query_see_board}
			AND c.forumid = {int:forumid}
		ORDER BY t.id_first_msg DESC
		LIMIT ' . $start . ', ' . $limit,
		array(
			'current_board' => $board,
			'is_approved' => 1,
			'forumid' => (int) $forumid,
		)]]></add>
	</operation>
	
	<!-- ssi_recentAttachments function -->
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $context, $modSettings, $scripturl, $txt, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}topics AS t ON (t.id_topic = m.id_topic)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[AND att.approved = {int:is_approved}') . '
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(
			'boards_can_see' => $attachments_boards,]]></search>
		<add><![CDATA[AND att.approved = {int:is_approved}') . '
			AND c.forumid = {int:forumid}
		ORDER BY att.id_attach DESC
		LIMIT {int:num_attachments}',
		array(
			'forumid' => (int) $forumid,
			'boards_can_see' => $attachments_boards,]]></add>
	</operation>
</file>
<file name="$sourcedir/Admin.php">
	<operation>
		<search position="replace"><![CDATA[loadTemplate('Admin', 'admin');]]></search>
		<add><![CDATA[loadTemplate('Admin', array('admin', 'splitforum'));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Any files to include for administration?]]></search>
		<add><![CDATA[// Subforum means no package manager and server settings access
	if ($forumid <> 0) 
	{
		unset($admin_areas['forum']['areas']['packages']);
		unset($admin_areas['layout']['areas']['subforums']['subsections']['newsub']);
		unset($admin_areas['layout']['areas']['subforums']['subsections']['settings']);
		unset($admin_areas['config']['areas']['serversettings']);
	}
	
	// Any files to include for administration?]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $txt, $context, $scripturl, $sc, $modSettings, $user_info, $settings, $sourcedir, $options, $smcFunc, $boarddir]]></search>
		<add><![CDATA[global $txt, $context, $scripturl, $sc, $modSettings, $user_info, $settings, $sourcedir, $options, $smcFunc, $boarddir, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Load the language and templates....]]></search>
		<add><![CDATA[$context['req_forumid'] = (int) (empty($_REQUEST['sub']) ? $forumid : $_REQUEST['sub']);
	
	// Load the language and templates....
	loadLanguage('ManageSplitForums');]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['layout' => array(
			'title' => $txt['layout_controls'],
			'permission' => array('manage_boards', 'admin_forum', 'manage_smileys', 'manage_attachments', 'moderate_forum'),
			'areas' => array(
]]></search>
		<add><![CDATA[				'subforums' => array(
					'label' => ($forumid != 0 ? $txt['subforum_modify_header'] : $txt['subforums_list']),
					'file' => 'ManageSplitForums.php',
					'function' => 'ManageSplitForums',
					'icon' => 'server.gif',
					'subsections' => array(
						'main' => array($forumid != 0 ? $txt['subforum_modify_header'] : $txt['subforums_list'], 'admin_forum'),
						'newsub' => array($txt['subforums_list_add'], 'admin_forum'),
						'settings' => array($txt['settings'], 'admin_forum'),
					),
				),
]]></add>
	</operation>
	<operation error="ignore">
		<search position="replace"><![CDATA['add' => array($txt['sp-adminBlockAddName']),
						'header' => array($txt['sp-positionHeader']),
						'left' => array($txt['sp-positionLeft']),
						'top' => array($txt['sp-positionTop']),
						'bottom' => array($txt['sp-positionBottom']),
						'right' => array($txt['sp-positionRight']),
						'footer' => array($txt['sp-positionFooter']),]]></search>
		<add><![CDATA['add' => array($txt['sp-adminBlockAddName'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=add;sub=' . $context['req_forumid']),
						'header' => array($txt['sp-positionHeader'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=header;sub=' . $context['req_forumid']),
						'left' => array($txt['sp-positionLeft'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=left;sub=' . $context['req_forumid']),
						'top' => array($txt['sp-positionTop'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=top;sub=' . $context['req_forumid']),
						'bottom' => array($txt['sp-positionBottom'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=bottom;sub=' . $context['req_forumid']),
						'right' => array($txt['sp-positionRight'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=right;sub=' . $context['req_forumid']),
						'footer' => array($txt['sp-positionFooter'], 'url' => $scripturl . '?action=admin;area=portalblocks;sa=footer;sub=' . $context['req_forumid']),]]></add>
	</operation>
</file>
<file name="$sourcedir/Load.php">
	<operation>
		<search position="after"><![CDATA[// UTF-8 in regular expressions is unsupported on PHP(win) versions < 4.2.3.]]></search>
		<add><![CDATA[// Replace the Simple Portal settings with the Subforum setting if available:
	if (isset($subforum_tree[$forumid]['sp_portal']))
		$modSettings['sp_portal_mode'] = $subforum_tree[$forumid]['sp_portal'];
	if (isset($subforum_tree[$forumid]['sp_standalone']))
		$modSettings['sp_standalone_url'] = $subforum_tree[$forumid]['sp_standalone'];
		
	]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function reloadSettings()
{
	global $modSettings, $boarddir, $smcFunc, $txt, $db_character_set, $context, $sourcedir;]]></search>
		<add><![CDATA[function reloadSettings()
{
	global $modSettings, $boarddir, $smcFunc, $txt, $db_character_set, $context, $sourcedir;
	global $boardurl, $cookiename, $boarddir, $forumid, $mbname, $subtheme, $language, $favicon, $subforum_tree;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Most database systems have not set UTF-8 as their default input charset.]]></search>
		<add><![CDATA[// Define primary subforum entry if it is not already defined:
	global $cookiename, $boardurl, $mbname, $language, $boarddir;
	if (!is_array($subforum_tree))
		$subforum_tree = array(
			0 => array(		// Primary subforum
				'forumid' => 0,
				'cookiename' => $cookiename,
				'boardurl' => $boardurl,
				'boardname' => $mbname,
				'language' => $language,
				'forumdir' => $boarddir,
				'favicon' => '',
				'primary_membergroup' => 0,
				'subtheme' => 0,
			),
		);

	// Determine which subforum we are in and load settings for it:
	$host = strtolower($_SERVER['SERVER_NAME']);
	$uri = str_replace('/index.php', '', substr($_SERVER['REQUEST_URI'], 0, strrpos($_SERVER['REQUEST_URI'], '/')));
	foreach ($subforum_tree as $id => $row)
	{
		$url = parse_url($row['boardurl']);
		$test1 = strtolower($url['host']);
		$test2 = strtolower(str_replace('www.', '', $test1));
		$check = (($test1 == $host || $test2 == $host) && $url['path'] == $uri);
		if (!empty($row['sp_standalone']))
		{
			$url = parse_url($row['sp_standalone']);
			$test1 = strtolower($url['host']);
			$test2 = strtolower(str_replace('www.', '', $test1));
			$check = $check || (($test1 == $host || $test2 == $host) && $url['path'] == $uri);
		}			
		if ($check)
		{
			// Assign global variables with row gleaned from database:
			$forumid = $row['forumid'];
			$boardurl = $row['boardurl'];
			$forumdir = $row['forumdir'];
			$subtheme = $row['subtheme'];
			$mbname = $row['boardname'];
			$cookiename = $row['cookiename'];
			$language = $row['language'];
			$favicon = $row['favicon'];
			$modSettings['primary_membergroup'] = $row['primary_membergroup'];
		}
	}
	$forumid = (int) $forumid;

	// Most database systems have not set UTF-8 as their default input charset.]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $context, $settings, $options, $sourcedir, $ssi_theme, $smcFunc;]]></search>
		<add><![CDATA[global $context, $settings, $options, $sourcedir, $ssi_theme, $smcFunc, $subtheme, $forumid;
	
	// load subforum theme if we are in one.
	if ($forumid <> 0) $id_theme = $subtheme;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $txt, $scripturl, $context, $modSettings;]]></search>
		<add><![CDATA[global $subtheme, $forumid, $txt, $scripturl, $context, $modSettings, $boardurl;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[b.id_parent, c.name AS cname,]]></search>
		<add><![CDATA[b.id_parent, c.name AS cname, c.forumid,]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Set the current board.]]></search>
		<add><![CDATA[if ((int)$row['forumid'] != $forumid) {
				// Find the right subforum to redirect to:
				global $subforum_tree;
				$sub = (isset($subforum_tree[(int) $row['forumid']]) ? $subforum_tree[(int) $row['forumid']] : 0);

				// If the "subforum_redirect_wrong" variable is set and $sub isn't empty, then redirect:
				if (!empty($modSettings['subforum_redirect_wrong']) && (!empty($sub)))
					redirectexit(str_replace($boardurl, $sub['boardurl'], 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']));

				// Throw error about wrong forum:
				loadPermissions();
				loadTheme();
				fatal_lang_error('wrong_forum', false);
			}

			]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageBoards.php">
	<operation>
		<search position="replace"><![CDATA[global $context, $txt, $sourcedir, $modSettings, $scripturl, $smcFunc;]]></search>
		<add><![CDATA[global $forumid, $context, $txt, $sourcedir, $modSettings, $scripturl, $smcFunc;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => true,]]></search>
		<add><![CDATA[
			'forumid' => (!empty($_REQUEST['sub']) ? $_REQUEST['sub'] : 0),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => !empty($cat_tree[$_REQUEST['cat']]['node']['can_collapse']),]]></search>
		<add><![CDATA[
			'forumid' => (int)($cat_tree[$_REQUEST['cat']]['node']['forumid']),]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$catOptions['is_collapsible'] = isset($_POST['collapse']);]]></search>
		<add><![CDATA[
		$catOptions['forumid'] = (int)($_POST['forum_id']);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function ManageBoardsMain()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $scripturl, $sourcedir, $txt;

	loadTemplate('ManageBoards');]]></search>
		<add><![CDATA[function ManageBoardsMain()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $scripturl, $sourcedir, $txt;
	global $boardurl, $forumid;

	loadTemplate('ManageBoards');]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid] = array(]]></search>
		<add><![CDATA[$context['categories'][$catid] = array(
			'forumid' => $tree['node']['forumid'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[}
	// Category doesn't exist, man... sorry.
	elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[}
	// Category doesn't exist, man... sorry.
	elseif (!isset($cat_tree[$_REQUEST['cat']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[redirectexit('action=admin;area=manageboards');
}

// Modify a specific board...
function EditBoard()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $sourcedir, $smcFunc, $modSettings;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();]]></search>
		<add><![CDATA[redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));
}

// Modify a specific board...
function EditBoard()
{
	global $txt, $context, $cat_tree, $boards, $boardList, $sourcedir, $smcFunc, $modSettings, $forumid, $subforum_tree;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if ($_REQUEST['sa'] == 'newboard')
	{
		// Category doesn't exist, man... sorry.
		if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[if ($_REQUEST['sa'] == 'newboard')
	{
		// Category doesn't exist, man... sorry.
		if (empty($_REQUEST['cat']))
			redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards');

	foreach ($boardList[$curBoard['category']] as $boardid)
	{
		if ($boardid == $_REQUEST['boardid'])
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
				'children' => $boards[$boardid]['tree']['children'],
				'no_children' => empty($boards[$boardid]['tree']['children']),
				'is_child' => false,
				'selected' => true
			);
		}
		else
		{
			$context['board_order'][] = array(
				'id' => $boardid,
				'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
				'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
				'selected' => false
			);
		}
	}]]></search>
		<add><![CDATA[// Category doesn't exist, man... sorry.
	if (!isset($boardList[$curBoard['category']]))
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));

	$selected_cat = -1;
	foreach ($boardList as $cat => $list)
	{
		$context['board_order'][$cat] = array();
		foreach ($list as $boardid)
		{
			if ($boardid == $_REQUEST['boardid'])
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' (' . $txt['mboards_current_position'] . ')',
					'children' => $boards[$boardid]['tree']['children'],
					'no_children' => empty($boards[$boardid]['tree']['children']),
					'is_child' => false,
					'selected' => true
				);
				$selected_cat = $cat;
			}
			else
			{
				$context['board_order'][$cat][] = array(
					'id' => $boardid,
					'name' => str_repeat('-', $boards[$boardid]['level']) . ' ' . $boards[$boardid]['name'],
					'is_child' => empty($_REQUEST['boardid']) ? false : isChildOf($boardid, $_REQUEST['boardid']),
					'selected' => false
				);
			}
		}
	}
	foreach ($context['board_order'] as $cat => $boards)
	{
		if ($selected_cat != $cat && !empty($context['board_order'][$cat][0]['selected']))
			$context['board_order'][$cat][0]['selected'] = true;
	}]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (isset($_REQUEST['rid']) && $_REQUEST['rid'] == 'permissions')
		redirectexit('action=admin;area=permissions;sa=board;' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards');]]></search>
		<add><![CDATA[if (isset($_REQUEST['rid']) && $_REQUEST['rid'] == 'permissions')
		redirectexit('action=admin;area=permissions;sa=board' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : '') . ';' . $context['session_var'] . '=' . $context['session_id']);
	else
		redirectexit('action=admin;area=manageboards' . (!empty($_REQUEST['sub']) ? ';sub=' . $_REQUEST['sub'] : ''));]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function EditCategory()
{
	global $txt, $context, $cat_tree, $boardList, $boards, $sourcedir;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree();]]></search>
		<add><![CDATA[function EditCategory()
{
	global $txt, $context, $cat_tree, $boardList, $boards, $sourcedir, $forumid, $subforum_tree;

	loadTemplate('ManageBoards');
	require_once($sourcedir . '/Subs-Boards.php');
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[getBoardTree();

	$context['move_board'] = !empty($_REQUEST['move']) && isset($boards[(int) $_REQUEST['move']]) ? (int) $_REQUEST['move'] : 0;]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );

	$context['move_board'] = !empty($_REQUEST['move']) && isset($boards[(int) $_REQUEST['move']]) ? (int) $_REQUEST['move'] : 0;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Start with one - "In first place".
	$context['category_order'] = array(
		array(
			'id' => 0,
			'name' => $txt['mboards_order_first'],
			'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
			'true_name' => ''
		)
	);]]></search>
		<add><![CDATA[// Start with one - "In first place".
	$context['category_order'] = array();
	foreach ($subforum_tree as $stuff)
		$context['category_order'][$stuff['forumid']] = array(
			array(
				'id' => 0,
				'name' => $txt['mboards_order_first'],
				'selected' => !empty($_REQUEST['cat']) ? $cat_tree[$_REQUEST['cat']]['is_first'] : false,
				'true_name' => ''
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['category_order'][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$catid] = array(]]></search>
		<add><![CDATA[$context['category_order'][$tree['node']['forumid']][$prevCat]['selected'] = true;
		elseif ($catid != $_REQUEST['cat'])
			$context['category_order'][$tree['node']['forumid']][$catid] = array(
				'forumid' => $tree['node']['forumid'],]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (isset($_POST['cat_order']))
			$catOptions['move_after'] = (int) $_POST['cat_order'];]]></search>
		<add><![CDATA[if (isset($_POST['cat_order' . ((int) $_POST['forum_id'])]))
			$catOptions['move_after'] = (int) $_POST['cat_order' . ((int) $_POST['forum_id'])];]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($cat_tree as $catID => $tree)
		$context['categories'][] = array(
			'id' => $catID == $curBoard['category'] ? 0 : $catID,]]></search>
		<add><![CDATA[foreach ($subforum_tree as $subforum)
		$context['categories'][$subforum['forumid']] = array();
	foreach ($cat_tree as $catID => $tree)
		$context['categories'][$tree['node']['forumid']][] = array(
			'id' => $catID,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $txt, $sourcedir, $modSettings, $smcFunc, $context]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search positon="replace"><![CDATA[$boardOptions = array();

		// Move this board to a new category?
		if (!empty($_POST['new_cat']))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = (int) $_POST['new_cat'];
		}
		// Change the boardorder of this board?
		elseif (!empty($_POST['placement']) && !empty($_POST['board_order']))
		{
			if (!in_array($_POST['placement'], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement'];
			$boardOptions['target_board'] = (int) $_POST['board_order'];]]></search>
		<add><![CDATA[$boardOptions = array();
		$sub = (!empty($_POST['new_forum']) ? $_POST['new_forum'] : $forumid);
		
		// Move this board to a new category?
		$cat = (!empty($_GET['cat']) ? $_GET['cat'] : '');
		if (!empty($_POST['new_cat' . $sub]))
		{
			$boardOptions['move_to'] = 'bottom';
			$boardOptions['target_category'] = $cat = (int) $_POST['new_cat' . $sub];
		}			
			
		// Change the boardorder of this board?
		if (!empty($_POST['placement' . $cat]) && !empty($_POST['board_order' . $cat]))
		{
			if (!in_array($_POST['placement' . $cat], array('before', 'after', 'child')))
				fatal_lang_error('mangled_post', false);

			$boardOptions['move_to'] = $_POST['placement' . $cat];
			$boardOptions['target_board'] = (int) $_POST['board_order' . $cat];]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		foreach ($context['board_order'] as $board)
			if ($board['is_child'] == false && $board['selected'] == false)
				$context['can_move_children'] = true;]]></search>
		<add><![CDATA[if (isset($boards[$_REQUEST['boardid']]['tree']['children']))
			$context['children'] = $boards[$_REQUEST['boardid']]['tree']['children'];
		else
			$context['children'] = array();
		foreach ($context['board_order'] as $cat => $list)
			foreach ($list as $board)
				if ($board['is_child'] == false && $board['selected'] == false)
					$context['can_move_children'] = true;]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageCalendar.php">
	<operation>
		<search position="replace"><![CDATA[global $modSettings, $context, $settings, $txt, $boarddir, $sourcedir, $scripturl, $smcFunc;]]></search>
		<add><![CDATA[global $forumid, $modSettings, $context, $settings, $txt, $boarddir, $sourcedir, $scripturl, $smcFunc;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageMaintenance.php">
	<operation>
		<search position="replace"><![CDATA[	global $context, $smcFunc, $txt;

	// Let's load up the boards in case they are useful.]]></search>
		<add><![CDATA[	global $forumid, $context, $smcFunc, $txt;

	// Let's load up the boards in case they are useful.]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageRegistration.php">
	<operation>
		<search position="replace"><![CDATA[function ModifyRegistrationSettings($return_config = false)
{
	global $txt, $context, $scripturl, $modSettings, $sourcedir;

	// This is really quite wanting.
	require_once($sourcedir . '/ManageServer.php');
]]></search>
		<add><![CDATA[function ModifyRegistrationSettings($return_config = false)
{
	global $txt, $context, $scripturl, $modSettings, $sourcedir, $smcFunc;

	// This is really quite wanting.
	require_once($sourcedir . '/ManageServer.php');

    // Build an array for the membergroup list:
    loadLanguage('Profile');
	$group_list = array($txt['admin_register_group_none']);
	$request = $smcFunc['db_query']('', '
		SELECT group_name, id_group, min_posts
		FROM {db_prefix}membergroups
		WHERE id_group > {int:moderator_group}
		ORDER BY min_posts, group_name',
		array(
			'moderator_group' => 3,
		)
	);
    while ($row = $smcFunc['db_fetch_assoc']($request))
		if ($row['min_posts'] != -1) $group_list[$row['id_group']] = $row['group_name'];
    $smcFunc['db_free_result']($request);

]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[array('check', 'send_welcomeEmail'),]]></search>
		<add><![CDATA[array('check', 'send_welcomeEmail'),
			array('select', 'primary_membergroup', $group_list),]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function EditAgreement()
{
	global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings;]]></search>
		<add><![CDATA[function EditAgreement()
{
	global $txt, $boarddir, $context, $modSettings, $smcFunc, $settings, $forumid;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Try to figure out if we have more agreements.
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/agreement.' . $lang['filename'] . '.txt'))
		{
			$context['editable_agreements']['.' . $lang['filename']] = $lang['name'];
			// Are we editing this?
			if (isset($_POST['agree_lang']) && $_POST['agree_lang'] == '.' . $lang['filename'])
				$context['current_agreement'] = '.' . $lang['filename'];
		}
	}

	if (isset($_POST['agreement']))
	{
		checkSession();

		// Off it goes to the agreement file.
		$fp = fopen($boarddir . '/agreement' . $context['current_agreement'] . '.txt', 'w');
		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
		fclose($fp);

		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
	}

	$context['agreement'] = file_exists($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/agreement' . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/agreement' . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></search>
		<add><![CDATA[// Try to figure out if we have more agreements.
	$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid);
	foreach ($context['languages'] as $lang)
	{
		if (file_exists($boarddir . '/' . $agree . $lang['filename'] . '.txt'))
		{
			$context['editable_agreements']['.' . $lang['filename']] = $lang['name'];
			// Are we editing this?
			if (isset($_POST['agree_lang']) && $_POST['agree_lang'] == '.' . $lang['filename'])
				$context['current_agreement'] = '.' . $lang['filename'];
		}
	}

	if (isset($_POST['agreement']))
	{
		checkSession();

		// Off it goes to the agreement file.
		$fp = fopen($boarddir . '/' . $agree . $context['current_agreement'] . '.txt', 'w');
		fwrite($fp, str_replace("\r", '', $_POST['agreement']));
		fclose($fp);

		updateSettings(array('requireAgreement' => !empty($_POST['requireAgreement'])));
	}

	$context['agreement'] = file_exists($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? htmlspecialchars(file_get_contents($boarddir . '/' . $agree . $context['current_agreement'] . '.txt')) : '';
	$context['warning'] = is_writable($boarddir . '/' . $agree . $context['current_agreement'] . '.txt') ? '' : $txt['agreement_not_writable'];]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageServer.php">
	<operation>
		<search position="replace"><![CDATA[array('cachedir', $txt['cachedir'], 'file', 'text', 36),]]></search>
		<add><![CDATA[array('cachedir', $txt['cachedir'], 'file', 'text', 36),
		array('favicon', $txt['favicon'], 'file', 'text', 36),]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['boarddir', 'sourcedir', 'cachedir',]]></search>
		<add><![CDATA['boarddir', 'sourcedir', 'cachedir', 'favicon',]]></add>
	</operation>
</file>
<file name="$sourcedir/News.php">
	<operation>
		<search position="replace"><![CDATA[function getXmlNews($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board;]]></search>
		<add><![CDATA[function getXmlNews($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board, $forumid;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function getXmlRecent($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board;]]></search>
		<add><![CDATA[function getXmlRecent($xml_format)
{
	global $user_info, $scripturl, $modSettings, $board, $forumid;]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND t.approved = {int:is_approved}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND m.approved = {int:is_approved}' : '') . ']]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['current_board' => $board,
				'is_approved' => 1,
				'optimize_msg' => $optimize_msg,]]></search>
		<add><![CDATA['current_board' => $board,
				'is_approved' => 1,
				'optimize_msg' => $optimize_msg,
				'forumid' => $forumid,]]></add>
	</operation>
</file>
<file name="$sourcedir/Packages.php">
	<operation>
		<search position="replace"><![CDATA[function Packages()
{
	global $txt, $scripturl, $sourcedir, $context;]]></search>
		<add><![CDATA[function Packages()
{
	global $txt, $scripturl, $sourcedir, $context, $forumid;

	if ($forumid <> 0) { // subforum means no packages access
		isAllowedTo('admin_forum');
		require_once($sourcedir . '/Subs-Package.php');
		loadLanguage('Packages');
		loadTemplate('Packages', 'packages');
		$context[$context['admin_menu_name']]['tab_data'] = array(
			'title' => &$txt['package_manager'],
			'description' => $txt['package_manager_desc'],
			'tabs' => array());
		fatal_lang_error('no_pack_in_subforum', false);
	}]]></add>
	</operation>
</file>
<file name="$sourcedir/PostModeration.php">
	<operation>
		<search position="replace"><![CDATA[global $txt, $scripturl, $context, $user_info, $sourcedir, $smcFunc;]]></search>
		<add><![CDATA[global $forumid, $txt, $scripturl, $context, $user_info, $sourcedir, $smcFunc;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/Profile-Modify.php">
	<operation>
		<search position="replace"><![CDATA[global $txt, $user_info, $context, $modSettings, $smcFunc, $cur_profile;]]></search>
		<add><![CDATA[global $forumid, $txt, $user_info, $context, $modSettings, $smcFunc, $cur_profile;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/Recent.php">
	<operation>
		<search position="replace"><![CDATA[global $user_info, $scripturl, $modSettings, $smcFunc;]]></search>
		<add><![CDATA[global $user_info, $scripturl, $modSettings, $smcFunc, $forumid;]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}messages AS ml ON (ml.id_msg = b.id_last_msg)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND ml.approved = {int:is_approved}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['recycle_board' => $modSettings['recycle_board'],
			'is_approved' => 1,]]></search>
		<add><![CDATA[
			'forumid' => $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$sourcedir, $board, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[INNER JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
		<add><![CDATA[
			INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[AND m.approved = {int:is_approved}]]></search>
		<add><![CDATA[
			AND c.forumid = {int:forumid}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['limit' => 10,]]></search>
		<add><![CDATA[
			'forumid' => $forumid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$scripturl, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board, b.id_parent
			FROM {db_prefix}boards AS b
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})
			ORDER BY child_level ASC
			',
			array(
				'no_child' => 0,
				'boards' => $boards,
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board, b.id_parent
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE {query_wanna_see_board}
				AND b.child_level > {int:no_child}
				AND b.id_board NOT IN ({array_int:boards})
				AND c.forumid = {int:forumid}
			ORDER BY child_level ASC
			',
			array(
				'no_child' => 0,
				'boards' => $boards,
				'forumid' => $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})',
			array(
				'board_list' => $_REQUEST['boards'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_Cat)
			WHERE {query_see_board}
				AND b.id_board IN ({array_int:board_list})
				AND c.forumid = {int:forumid}',
			array(
				'board_list' => $_REQUEST['boards'],
				'forumid' => $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})',
			array(
				'id_cat' => $_REQUEST['c'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			WHERE ' . $user_info[$see_board] . '
				AND b.id_cat IN ({array_int:id_cat})
				AND c.forumid = {int:forumid}',
			array(
				'id_cat' => $_REQUEST['c'],
				'forumid' => $forumid,
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : ''),
			array(
				'recycle_board' => (int) $modSettings['recycle_board'],
			)
		);]]></search>
		<add><![CDATA[		$request = $smcFunc['db_query']('', '
			SELECT b.id_board
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (b.id_cat = c.id_cat)
			WHERE ' . $user_info[$see_board] . (!empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] > 0 ? '
				AND b.id_board != {int:recycle_board}' : '').
				' AND c.forumid = {int:forumid}',
			array(
				'recycle_board' => (int) $modSettings['recycle_board'],
				'forumid' => $forumid
			)
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[			fatal_lang_error('error_no_boards_selected');

		$query_this_board = 'id_board IN ({array_int:boards})';]]></search>
		<add><![CDATA[			fatal_lang_error('wrong_forum', false);

		$query_this_board = 'id_board IN ({array_int:boards})';]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[			fatal_lang_error('error_no_boards_selected');

		$query_this_board = 'id_board IN ({array_int:boards})';]]></search>
		<add><![CDATA[			fatal_lang_error('wrong_forum', false);

		$query_this_board = 'id_board IN ({array_int:boards})';]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[			fatal_lang_error('error_no_boards_selected');

		$query_this_board = 'id_board IN ({array_int:boards})';]]></search>
		<add><![CDATA[			fatal_lang_error('wrong_forum', false);

		$query_this_board = 'id_board IN ({array_int:boards})';]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[			fatal_lang_error('error_no_boards_selected');

		$query_this_board = 'id_board IN ({array_int:boards})';]]></search>
		<add><![CDATA[			fatal_lang_error('wrong_forum', false);

		$query_this_board = 'id_board IN ({array_int:boards})';]]></add>
	</operation>
</file>
<file name="$sourcedir/Register.php">
	<operation>
		<search position="replace"><![CDATA[global $txt, $boarddir, $context, $settings, $modSettings, $user_info]]></search>
		<add><![CDATA[global $txt, $boarddir, $context, $settings, $modSettings, $user_info, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Have we got a localized one?
		if (file_exists($boarddir . '/agreement.' . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.' . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/agreement.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/agreement.txt'), true, 'agreement');]]></search>
		<add><![CDATA[// Have we got a localized one?
		$agree = 'agreement' . ($forumid == 0 ? '' : '.forum' . $forumid . '.');
		if (file_exists($boarddir . '/' . $agree . $user_info['language'] . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . $user_info['language'] . '.txt'), true, 'agreement_' . $user_info['language']);
		elseif (file_exists($boarddir . '/' . $agree . '.txt'))
			$context['agreement'] = parse_bbc(file_get_contents($boarddir . '/' . $agree . '.txt'), true, 'agreement');]]></add>
	</operation>
</file>
<file name="$sourcedir/Reports.php">
	<operation>
		<search position="replace"><![CDATA[global $context, $txt, $sourcedir, $smcFunc;]]></search>
		<add><![CDATA[global $forumid, $context, $txt, $sourcedir, $smcFunc;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/Search.php">
	<operation>
		<search position="replace"><![CDATA[global $txt, $scripturl, $modSettings, $user_info, $context, $smcFunc, $sourcedir;]]></search>
		<add><![CDATA[global $forumid, $txt, $scripturl, $modSettings, $user_info, $context, $smcFunc, $sourcedir;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT b.id_cat, c.name AS cat_name, b.id_board, b.name, b.child_level]]></search>
		<add><![CDATA[SELECT b.id_cat, c.name AS cat_name, c.forumid, b.id_board, b.name, b.child_level]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// This category hasn't been set up yet..]]></search>
		<add><![CDATA[		if ((int)$row['forumid'] != $forumid) // non-viewable board
			continue;
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $scripturl, $modSettings, $sourcedir, $txt, $db_connection;]]></search>
		<add><![CDATA[global $forumid, $scripturl, $modSettings, $sourcedir, $txt, $db_connection;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs.php">
	<operation>
		<search position="before"><![CDATA[function setupMenuContext()
{
	global $context, $modSettings, $user_info, $txt, $scripturl;]]></search>
		<add><![CDATA[
	global $forumid;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum'),]]></search>
		<add><![CDATA['href' => $scripturl . '?action=admin;area=packages',
						'show' => allowedTo('admin_forum') && ($forumid == 0),]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Admin.php">
	<operation>
		<search position="replace"><![CDATA[function updateSettingsFile($config_vars)
{
	global $boarddir, $cachedir;]]></search>
		<add><![CDATA[function updateSettingsFile($config_vars)
{
	global $boarddir, $cachedir, $forumid, $subforum_tree;

	// Put available data in the Subforum Tree variable:
	if (isset($config_vars['mbname']))
		$subforum_tree[$forumid]['boardname'] = $config_vars['mbname'];
	if (isset($config_vars['boardurl']))
		$subforum_tree[$forumid]['boardurl'] = $config_vars['boardurl'];
	if (isset($config_vars['cookiename']))
		$subforum_tree[$forumid]['cookiename'] = $config_vars['cookiename'];
	if (isset($config_vars['favicon']))
		$subforum_tree[$forumid]['favicon'] = $config_vars['favicon'];
	unset($config_vars['favicon']);
	
	// Clear some variables if we are in a subforum:
	if ((isset($config_vars['mbname']) || isset($config_vars['boardurl']) || isset($config_vars['cookiename'])) && $forumid != 0)
	{
		unset($config_vars['mbname']);
		unset($config_vars['boardurl']);
		unset($config_vars['cookiename']);
	}]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-BoardIndex.php">
	<operation>
		<search position="replace"><![CDATA[global $settings, $context;]]></search>
		<add><![CDATA[global $forumid, $settings, $context;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[// Haven't set this category yet.]]></search>
		<add><![CDATA[			if ((int)$row_board['id_cat'] == 0)
				continue; // skip this board, as its category parent is not visible
			
]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Boards.php">
	<operation>
		<search position="before"><![CDATA[global $sourcedir, $cat_tree, $boards, $boardList, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree();]]></search>
		<add><![CDATA[// Get some basic information about all boards and categories.
	getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function getBoardTree()
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc;

	// Getting all the board and category information you'd ever wanted.]]></search>
		<add><![CDATA[function getBoardTree($reqid = 0)
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc, $forumid, $subforum_tree;

	// Build the subforum tree array:
	if ($forumid <> 0)
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);
	
	// Getting all the board and category information you'd ever wanted.
	$reqid = (int) ($forumid == 0 ? $reqid : $forumid);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		]]></search>
		<add><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		if (!isset($subforum_tree[$row['forumid']]))
			$subforum_tree[$row['forumid']] = array('forumid' => (int) $row['forumid']);
			
		]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		ORDER BY c.cat_order, b.child_level, b.board_order',
		array(]]></search>
		<add><![CDATA[c.id_cat, c.name AS cat_name, c.cat_order, c.can_collapse, c.forumid
		FROM {db_prefix}categories AS c
			LEFT JOIN {db_prefix}boards AS b ON (b.id_cat = c.id_cat)
		'.($reqid <> -1 ? 'WHERE c.forumid = {int:forumid}' : '').'
		ORDER BY c.forumid, c.cat_order, b.child_level, b.board_order',
		array(
			'forumid' => (int) $reqid,]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['can_collapse' => $row['can_collapse']]]></search>
		<add><![CDATA[,
					'forumid' => $row['forumid']]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Categories.php">
	<operation>
		<search position="after"><![CDATA[	// Do the updates (if any).]]></search>
		<add><![CDATA[	// Which forum will this category be displayed on?
	if (isset($catOptions['forumid']))
	{
		$catUpdates[] = 'forumid = {int:forumid}';
		$catParameters['forumid'] = (int)$catOptions['forumid'];
	}

	]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Members.php">
	<operation>
		<search position="replace"><![CDATA['id_post_group' => 4,]]></search>
		<add><![CDATA['id_group' => !empty($modSettings['primary_membergroup']) ? $modSettings['primary_membergroup'] : '0',
	'id_post_group' => 4,]]></add>
	</operation>
</file>	
<file name="$sourcedir/Subs-MessageIndex.php">
	<operation>
		<search position="replace"><![CDATA[global $smcFunc, $user_info;]]></search>
		<add><![CDATA[global $forumid, $smcFunc, $user_info;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)]]></search>
		<add><![CDATA[LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat AND c.forumid = '.$forumid.')]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[	$request = $smcFunc['db_query']('messageindex_fetch_boards', ']]></search>
		<add><![CDATA[	$where[] = 'b.id_cat = c.id_cat';
]]></add>
	</operation>
</file>

<!---------------------------------------------------------------------------->
<!-- Simple Portal block management modification							-->
<!---------------------------------------------------------------------------->
<file name="$sourcedir/PortalAdminBlocks.php" error="skip">
	<operation>
		<search position="before"><![CDATA[global $txt, $context, $modSettings, $smcFunc, $sourcedir, $boarddir, $boards]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['style' => sportal_parse_style('implode'),
		);]]></search>
		<add><![CDATA['style' => sportal_parse_style('implode'),
			'forum' => !empty($_POST['forum']) ? $_POST['forum'] : $forumid,
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['style' => 'string',
				),
				$blockInfo,
				array('id_block')]]></search>
		<add><![CDATA['style' => 'string',
					'forum' => 'int',
				),
				$blockInfo,
				array('id_block')]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA["style = {string:style}",]]></search>
		<add><![CDATA[
				"forum = {int:forum}",]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[global $context, $txt, $scripturl, $sourcedir;]]></search>
		<add><![CDATA[global $context, $txt, $scripturl, $sourcedir, $forumid;

	$context['req_forumid'] = (int) (empty($_REQUEST['sub']) ? $forumid : $_REQUEST['sub']);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['state_icon' => empty($block['state']) ? '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=statechange;' . (empty($context['sp_blocks_single_side_list']) ? '' : 'redirect=' . $block['column'] . ';') . 'block_id=' . $block['id'] . ';type=block;' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('deactive', $txt['sp-blocksActivate']) . '</a>' : '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=statechange;' . (empty($context['sp_blocks_single_side_list']) ? '' : 'redirect=' . $block['column'] . ';') . 'block_id=' . $block['id'] . ';type=block;' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('active', $txt['sp-blocksDeactivate']) . '</a>',
				'edit' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=edit;block_id=' . $block['id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('modify') . '</a>',
				'move' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=select;block_id=' . $block['id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('move', $txt['sp-adminColumnMove']) . '</a>',
				'delete' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=delete;block_id=' . $block['id'] . ';col=' . $block['column'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '" onclick="return confirm(\''.$txt['sp-deleteblock'].'\');">' . sp_embed_image('delete') . '</a>',]]></search>
		<add><![CDATA['state_icon' => empty($block['state']) ? '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=statechange;' . (empty($context['sp_blocks_single_side_list']) ? '' : 'redirect=' . $block['column'] . ';') . 'block_id=' . $block['id'] . ';type=block;' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('deactive', $txt['sp-blocksActivate']) . '</a>' : '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=statechange;' . (empty($context['sp_blocks_single_side_list']) ? '' : 'redirect=' . $block['column'] . ';') . 'block_id=' . $block['id'] . ';type=block;' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('active', $txt['sp-blocksDeactivate']) . '</a>',
				'edit' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=edit;block_id=' . $block['id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('modify') . '</a>',
				'move' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=select;block_id=' . $block['id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('move', $txt['sp-adminColumnMove']) . '</a>',
				'delete' => '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=delete;block_id=' . $block['id'] . ';col=' . $block['column'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '" onclick="return confirm(\''.$txt['sp-deleteblock'].'\');">' . sp_embed_image('delete') . '</a>',]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['blocks'][$side['name']][$block_id]['move_insert'] = '<a href="' . $scripturl . '?action=admin;area=portalblocks;sa=move;block_id=' . $context['block_move'] . ';col=' . $block['column'] . ';row=' . $block['row'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('arrow', $txt['sp-blocks_move_here']) . '</a>';]]></search>
		<add><![CDATA[$context['blocks'][$side['name']][$block_id]['move_insert'] = '<a href="' . $scripturl . '?action=admin;area=portalblocks;sub=' . $context['req_forumid'] . ';sa=move;block_id=' . $context['block_move'] . ';col=' . $block['column'] . ';row=' . $block['row'] . ';' . $context['session_var'] . '=' . $context['session_id'] . '">' . sp_embed_image('arrow', $txt['sp-blocks_move_here']) . '</a>';]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[);
		}

		redirectexit('action=admin;area=portalblocks');]]></search>
		<add><![CDATA[);
		}

		redirectexit('action=admin;area=portalblocks;sub=' . $context['req_forumid']);]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[	// ]]]]><![CDATA[></script>]]></search>
		<add><![CDATA[		function sp_hideBoards(forum)
		{';
	foreach ($subforum_tree as $subforum)
		$context['html_headers'] .= '
			document.getElementById("sfm_boards' . $subforum['forumid'] . '").style.display = forum == ' . $subforum['forumid'] . ' ? "" : "none";';
	$context['html_headers'] .= '
		}
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board, name
			FROM {db_prefix}boards
			ORDER BY name DESC'
		);
		$context['display_boards'] = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$context['display_boards']['b' . $row['id_board']] = $row['name'];]]></search>
		<add><![CDATA[SELECT b.id_board, b.name, c.forumid
			FROM {db_prefix}boards AS b
				INNER JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			' . ($forumid == 0 ? '' : 'WHERE c.forumid = {int:forumid}') . '
			ORDER BY name DESC',
			array(
				'forumid' => (int) $forumid,
			)
		);
		$context['display_boards'] = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$context['display_boards'.$row['forumid']]['b' . $row['id_board']] = $row['name'];]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['list_blocks' => !empty($_POST['block_column']) ? getBlockInfo($_POST['block_column']) : array(),]]></search>
		<add><![CDATA[
			'forum' => $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (!empty($_POST['display_boards']))
				foreach ($_POST['display_boards'] as $board)]]></search>
		<add><![CDATA[$forum = !empty($_POST['forums']) ? $_POST['forums'] : $forumid;
			if (!empty($_POST['display_boards' . $forum]))
				foreach ($_POST['display_boards' . $forum] as $board)]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[fixColumnRows($side);
	}

	redirectexit('action=admin;area=portalblocks');]]></search>
		<add><![CDATA[fixColumnRows($side);
	}

	redirectexit('action=admin;area=portalblocks;sub=' . $context['req_forumid']);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function sportal_admin_block_delete()
{
	global $smcFunc;]]></search>
		<add><![CDATA[function sportal_admin_block_delete()
{
	global $smcFunc, $context;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[fixColumnRows($_REQUEST['col']);

	// Return back to the block list.
	redirectexit('action=admin;area=portalblocks');]]></search>
		<add><![CDATA[fixColumnRows($_REQUEST['col']);

	// Return back to the block list.
	redirectexit('action=admin;area=portalblocks;sub=' . $context['req_forumid']);]]></add>
	</operation>
</file>
<file name="$sourcedir/PortalAdminMain.php" error="skip">
	<operation>
		<search position="before"><![CDATA[global $smcFunc, $context, $scripturl, $txt]]></search>
		<add><![CDATA[, $subforum_tree, $forumid, $sourcedir]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[saveDBSettings($config_vars);
		redirectexit('action=admin;area=portalconfig;sa=generalsettings');]]></search>
		<add><![CDATA[// Update the subforum array with the new settings:
		$subforum_tree[$forumid]['sp_portal'] = (int) $_POST['sp_portal_mode'];
		$subforum_tree[$forumid]['sp_standalone'] = $_POST['sp_standalone_url'];

		// Place the revised subforum array into the Settings.php file:
		require_once($sourcedir.'/Subs-Admin.php');
		updateSettingsFile(array('subforum_tree' => str_replace("\n", "", var_export($subforum_tree, true))));

		]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-Portal.php" error="skip">
	<operation>
		<search position="before"><![CDATA[spb.display_custom, spb.style, spp.variable, spp.value]]></search>
		<add><![CDATA[, spb.forum]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function getBlockInfo($column_id = null, $block_id = null, $state = null, $show = null, $permission = null)
{
	global $smcFunc, $context, $settings, $options, $txt;

	$query = array();
	$parameters = array();]]></search>
		<add><![CDATA[function getBlockInfo($column_id = null, $block_id = null, $state = null, $show = null, $permission = null)
{
	global $smcFunc, $context, $settings, $options, $txt, $forumid;

	$query = array('spb.forum = {int:forumid}');
	$parameters = array(
		'forumid' => (int) ($forumid == 0 ? (!empty($context['req_forumid']) ? $context['req_forumid'] : $forumid) : $forumid)
	);]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['parameters' => array(),]]></search>
		<add><![CDATA[
				'forum' => $row['forum'],]]></add>
	</operation>
</file>
<file name="$sourcedir/Subs-PortalAdmin.php" error="skip">
	<operation error="ignore">
		<search position="replace"><![CDATA[function fixColumnRows($column_id = null)
{
	global $smcFunc;]]></search>
		<add><![CDATA[function fixColumnRows($column_id = null)
{
	global $smcFunc, $forumid;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function sportal_admin_state_change()
{]]></search>
		<add><![CDATA[function sportal_admin_state_change()
{
	global $context;

]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[redirectexit('action=admin;area=portalblocks;sa=' . $list);
	}
	elseif($_REQUEST['type'] == 'category')
		redirectexit('action=admin;area=portalarticles;sa=categories');
	elseif($_REQUEST['type'] == 'article')
		redirectexit('action=admin;area=portalarticles;sa=articles');
	else
		redirectexit('action=admin;area=portalconfig');]]></search>
		<add><![CDATA[redirectexit('action=admin;area=portalblocks;sa=' . $list . ';sub=' . $context['req_forumid']);
	}
	elseif($_REQUEST['type'] == 'category')
		redirectexit('action=admin;area=portalarticles;sa=categories;sub=' . $context['req_forumid']);
	elseif($_REQUEST['type'] == 'article')
		redirectexit('action=admin;area=portalarticles;sa=articles;sub=' . $context['req_forumid']);
	else
		redirectexit('action=admin;area=portalconfig;sub=' . $context['req_forumid']);]]></add>
	</operation>
</file>
</modification>