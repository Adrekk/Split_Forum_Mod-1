<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>1.5</version>

<!-------------------------------------------------------------------------->
<!-- Incorrect subforum selected by Load.php (Load.php)                   -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Load.php">
	<operation>
		<search position="replace"><![CDATA[$dir = 'http://' . $_SERVER['HTTP_HOST'] . substr($dir, 0, strrpos($dir, '/'));]]></search>
		<add><![CDATA[$dir = str_replace('/index.php', '', 'http://' . $_SERVER['HTTP_HOST'] . substr($dir, 0, strrpos($dir, '/')));]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[

	// Most database systems have not set UTF-8 as their default input charset.]]></search>
		<add><![CDATA[
	$forumid = (int) $forumid;]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Boards not loading in Manage Boards UI (ManageBoards.template.php)   -->
<!-------------------------------------------------------------------------->
<file name="$themedir/ManageBoards.template.php">
	<operation>
		<search position="replace"><![CDATA[echo '<div id="subforum' . $category['forumid'] . '"' . ($context['req_forumid'] <> $category['forumid'] ? ' style="display: none;"' : '') . '>';]]></search>
		<add><![CDATA[echo '<div id="subforum' . $category['forumid'] . '"' . ($context['req_forumid'] <> (int)$category['forumid'] ? ' style="display: none;"' : '') . '>';]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Simple Portal block management modification (Subs-Portal.php)        -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Subs-Portal.php" error="skip">
	<operation>
		<search position="before"><![CDATA[spb.display_custom, spb.style, spp.variable, spp.value]]></search>
		<add><![CDATA[, spb.forums]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[function getBlockInfo($column_id = null, $block_id = null, $state = null, $show = null, $permission = null)
{
	global $smcFunc, $context, $settings, $options, $txt;

	$query = array();
	$parameters = array();]]></search>
		<add><![CDATA[function getBlockInfo($column_id = null, $block_id = null, $state = null, $show = null, $permission = null, $all_subforum = null)
{
	global $smcFunc, $context, $settings, $options, $txt, $forumid;

	$query = array();
	$parameters = array();
	if (empty($all_subforum))
	{
		$query[] = 'FIND_IN_SET({int:forumid}, spb.forums)';
		$parameters['forumid'] = (int) $forumid;
	}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA['parameters' => array(),]]></search>
		<add><![CDATA[
				'forums' => explode(',', $row['forums']),]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Simple Portal block management modification (Subs-PortalAdmin.php)   -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Subs-PortalAdmin.php" error="skip">
	<operation>
		<search position="replace"><![CDATA[$blockList = getBlockInfo($column_id]]></search>
		<add><![CDATA[$blockList = getBlockInfo($column_id, null, null, null, null, true);]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Simple Portal block management modification (PortalAdminBlocks.php)  -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/PortalAdminBlocks.php" error="skip">
	<operation>
		<search position="before"><![CDATA[global $txt, $context, $modSettings, $smcFunc, $sourcedir, $boarddir, $boards]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['style' => sportal_parse_style('implode'),
		);]]></search>
		<add><![CDATA['style' => sportal_parse_style('implode'),
			'forums' => !empty($_POST['forums']) ? implode(',', array_unique($_POST['forums'])) : $forumid,
		);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA['style' => 'string',
				),
				$blockInfo,
				array('id_block')]]></search>
		<add><![CDATA['style' => 'string',
					'forums' => 'string',
				),
				$blockInfo,
				array('id_block')]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA["style = {string:style}",]]></search>
		<add><![CDATA[
				"forums = {string:forums}",]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Simple Portal block management (PortalAdminBlocks.template.php)      -->
<!-------------------------------------------------------------------------->
<file name="$themedir/PortalAdminBlocks.template.php" error="skip">
	<operation>
		<search position="before"><![CDATA[global $context, $settings, $options, $scripturl, $txt, $helptxt, $modSettings]]></search>
		<add><![CDATA[, $forumid, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[echo '
		</form>
	</div>
	<script language="JavaScript" type="text/javascript"><!-- // --><![CDATA[]]></search>
		<add><![CDATA[if (count($subforum_tree) > 1)
	{
		echo '
			<br />
			<div class="cat_bar">
				<h3 class="catbg">', $txt['sp-subforums'], '</h3>
			</div>
			<div class="windowbg2">
				<span class="topslice"><span></span></span>
				<div class="sp_content_padding">
					<dl class="sp_form">';

		foreach ($subforum_tree as $id => $forum)
		{
			$forums = array();
			foreach ($context['SPortal']['block']['list_blocks'][$_REQUEST['block_id']]['forums'] as $subforum)
				$forums[$subforum] = 1;
			echo '
						<dd><input type="checkbox" name="forums[', $id, ']" value="', $id, '" id="forums', $id, '"', isset($forums[$id]) ? ' checked="checked"' : '', ' class="input_check" /><a href="', $forum['boardurl'], '">', $forum['boardname'], '</a></dd>';
		}

		echo '
					</dl>
					<div class="sp_button_container">
						<input type="submit" name="add_block" value="', !$context['SPortal']['is_new'] ? $txt['sp-blocksEdit'] : $txt['sp-blocksAdd'], '" class="button_submit" />
					</div>
				</div>
				<span class="botslice"><span></span></span>
			</div>';
	}
	
	]]></add>
	</operation>
</file>
</modification>