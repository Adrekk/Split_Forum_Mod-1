<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>1.27</version>

<file name="$sourcedir/Logging.php">
	<operation>
		<search position="before"><![CDATA[global $user_info, $user_settings, $context, $modSettings, $settings, $topic, $board, $smcFunc, $sourcedir]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT']);]]></search>
		<add><![CDATA[$serialized = $_GET + array('USER_AGENT' => $_SERVER['HTTP_USER_AGENT'], 'forumid' => $forumid);]]></add>
	</operation>
</file>
<file name="$sourcedir/ManageMembergroups.php">
	<operation>
		<search position="before"><![CDATA[function AddMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT b.id_cat, c.name AS cat_name, b.id_board, b.name, b.child_level
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		ORDER BY board_order',
		array(
		)
	);
	$context['num_boards'] = $smcFunc['db_num_rows']($request);

	$context['categories'] = array();
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		// This category hasn't been set up yet..
		if (!isset($context['categories'][$row['id_cat']]))
			$context['categories'][$row['id_cat']] = array(
				'id' => $row['id_cat'],
				'name' => $row['cat_name'],
				'boards' => array()
			);

		// Set this board up, and let the template know when it's a child.  (indent them..)
		$context['categories'][$row['id_cat']]['boards'][$row['id_board']] = array(]]></search>
		<add><![CDATA[SELECT b.id_cat, c.name AS cat_name, b.id_board, b.name, b.child_level, c.forumid
		FROM {db_prefix}boards AS b
			LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
		ORDER BY c.forumid, b.board_order',
		array(
		)
	);
	$context['num_boards'] = $smcFunc['db_num_rows']($request);

	$context['categories'] = array();
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		// This category hasn't been set up yet..
		if (!isset($context['categories'][$row['id_cat']]))
			$context['categories'][$row['forumid']][$row['id_cat']] = array(
				'id' => $row['id_cat'],
				'name' => $row['cat_name'],
				'boards' => array()
			);

		// Set this board up, and let the template know when it's a child.  (indent them..)
		$context['categories'][$row['forumid']][$row['id_cat']]['boards'][$row['id_board']] = array(]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($context['categories'] as $category)
	{
		$temp_boards[] = array(
			'name' => $category['name'],
			'child_ids' => array_keys($category['boards'])
		);
		$temp_boards = array_merge($temp_boards, array_values($category['boards']));

		// Include a list of boards per category for easy toggling.
		$context['categories'][$category['id']]['child_ids'] = array_keys($category['boards']);
	}]]></search>
		<add><![CDATA[foreach ($context['categories'] as $id => $subforum)
	{
		foreach ($subforum as $category)
		{
			$temp_boards[] = array(
				'name' => $category['name'],
				'child_ids' => array_keys($category['boards'])
			);
			$temp_boards = array_merge($temp_boards, array_values($category['boards']));

			// Include a list of boards per category for easy toggling.
			$context['categories'][$id][$category['id']]['child_ids'] = array_keys($category['boards']);
		}
	}]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function EditMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc, $settings]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT id_board, {raw:column}
					FROM {db_prefix}boards
					WHERE FIND_IN_SET({string:current_group}, {raw:column}) != 0' . (empty($changed_boards[$board_action]) ? '' : '
						AND id_board NOT IN ({array_int:board_access_list})'),
					array(]]></search>
		<add><![CDATA[SELECT b.id_board, b.{raw:column}
					FROM {db_prefix}boards AS b' . (empty($forumid) ? '' : '
						LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)') . '
					WHERE FIND_IN_SET({string:current_group}, b.{raw:column}) != 0' . (empty($changed_boards[$board_action]) ? '' : '
						AND b.id_board NOT IN ({array_int:board_access_list})') . (empty($forumid) ? '' : '
						AND c.forumid = {int:forumid}'),
					array(
						'forumid' => (int) $forumid,]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[SELECT b.id_cat, c.name as cat_name, b.id_board, b.name, b.child_level,
			FIND_IN_SET({string:current_group}, b.member_groups) != 0 AS can_access, FIND_IN_SET({string:current_group}, b.deny_member_groups) != 0 AS cannot_access
			FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)
			ORDER BY board_order',
			array(
				'current_group' => (int) $_REQUEST['group'],
			)
		);
		$context['categories'] = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			// This category hasn't been set up yet..
			if (!isset($context['categories'][$row['id_cat']]))
				$context['categories'][$row['id_cat']] = array(
					'id' => $row['id_cat'],
					'name' => $row['cat_name'],
					'boards' => array()
				);

			// Set this board up, and let the template know when it's a child.  (indent them..)
			$context['categories'][$row['id_cat']]['boards'][$row['id_board']] = array(]]></search>
		<add><![CDATA[SELECT b.id_cat, c.name as cat_name, b.id_board, b.name, b.child_level, c.forumid,
			FIND_IN_SET({string:current_group}, b.member_groups) != 0 AS can_access, FIND_IN_SET({string:current_group}, b.deny_member_groups) != 0 AS cannot_access
			FROM {db_prefix}boards AS b
				LEFT JOIN {db_prefix}categories AS c ON (c.id_cat = b.id_cat)' . (empty($forumid) ? '' : '
			WHERE c.forumid = {int:forumid}') . '
			ORDER BY board_order',
			array(
				'forumid' => (int) $forumid,
				'current_group' => (int) $_REQUEST['group'],
			)
		);
		$context['categories'] = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
		{
			// This category hasn't been set up yet..
			if (!isset($context['categories'][$row['forumid']][$row['id_cat']]))
				$context['categories'][$row['forumid']][$row['id_cat']] = array(
					'id' => $row['id_cat'],
					'name' => $row['cat_name'],
					'boards' => array()
				);

			// Set this board up, and let the template know when it's a child.  (indent them..)
			$context['categories'][$row['forumid']][$row['id_cat']]['boards'][$row['id_board']] = array(]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function AddMembergroup()
{
	global $context, $txt, $sourcedir, $modSettings, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Now, let's sort the list of categories into the boards for templates that like that.
		$temp_boards = array();
		foreach ($context['categories'] as $category)
		{
			$temp_boards[] = array(
				'name' => $category['name'],
				'child_ids' => array_keys($category['boards'])
			);
			$temp_boards = array_merge($temp_boards, array_values($category['boards']));

			// Include a list of boards per category for easy toggling.
			$context['categories'][$category['id']]['child_ids'] = array_keys($category['boards']);
		}]]></search>
		<add><![CDATA[// Now, let's sort the list of categories into the boards for templates that like that.
		$temp_boards = array();
		foreach ($context['categories'] as $id => $subforum)
		{
			foreach ($subforum as $category)
			{
				$temp_boards[] = array(
					'name' => $category['name'],
					'child_ids' => array_keys($category['boards'])
				);
				$temp_boards = array_merge($temp_boards, array_values($category['boards']));

				// Include a list of boards per category for easy toggling.
				$context['categories'][$id][$category['id']]['child_ids'] = array_keys($category['boards']);
			}
		]]></add>
	</operation>
</file>
<file name="$sourcedir/ManagePermissions.php">
	<operation>
		<search position="before"><![CDATA[function PermissionByBoard()
{
	global $context, $txt, $smcFunc, $sourcedir, $cat_tree, $boardList, $boards]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[global $context, $txt, $smcFunc, $sourcedir, $cat_tree, $boardList, $boards]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[getBoardTree();]]></search>
		<add><![CDATA[getBoardTree( ($forumid == 0 ? -1 : $forumid) );]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid] = array(]]></search>
		<add><![CDATA[$id = $cat_tree[$catid]['node']['forumid'];
		$context['categories'][$id][$catid] = array(]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$context['categories'][$catid]['boards'][$boardid] = array(]]></search>
		<add><![CDATA[$context['categories'][$id][$catid]['boards'][$boardid] = array(]]></add>
	</operation>
</file>
<file name="$sourcedir/Who.php">
	<operation>
		<search position="before"><![CDATA[global $context, $scripturl, $txt, $modSettings, $memberContext, $smcFunc]]></search>
		<add><![CDATA[, $forumid]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[$conditions = array();]]></search>
		<add><![CDATA[
	if (!empty($modSettings['subforum_settings_show_who_in_subforum']))
		$conditions[] = 'INSTR(lo.url, {string:in_url_string}) > 0';]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[WHERE ' . implode(' AND ', $conditions) : ''),
		array(]]></search>
		<add><![CDATA[
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[LIMIT {int:offset}, {int:limit}',
		array(]]></search>
		<add><![CDATA[
			'in_url_string' => 's:7:"forumid";i:' . ((int) $forumid) . ';',]]></add>
	</operation>
</file>
<file name="$themedir/ManageMembergroups.template.php">
	<operation>
		<search position="before"><![CDATA[function template_new_group()
{
	global $context, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[echo '
					<dt>
						<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br>
						<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
					</dt>
					<dd>';

	template_add_edit_group_boards_list(false);

	echo '
					</dd>
				</dl>]]></search>
		<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	if (!empty($context['categories']))
	{
		echo '
				</dl>';
		$flagged = array();
		if (count($subforum_tree) > 1)
		{
			echo '
				<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
					function expandTabs(forum)
					{
						';
			foreach ($subforum_tree as $subforum => $info)
				echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
						document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
						';
			echo '
					}
				// ]]]]><![CDATA[></script>
				<fieldset id="visible_boards">
					<legend>', $txt['membergroups_new_board_desc'], '</legend>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			}
			echo '
							</ul>
						</div>
					</div>
					<hr class="hrcolor" />';
		}
		$context_categories = $context['categories'];
		foreach ($context_categories as $id => $categories)
		{
			echo '
					<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>
						<dl class="settings">
							<dt>
								<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br>
								<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
							</dt>
							<dd>';

			$context['categories'] = $categories;
			template_add_edit_group_boards_list(false);

			echo '
							</dd>
						</dl>
					</div>';
			$flagged[$id] = true;
		}
		foreach ($subforum_tree as $id => $section)
		{
			if (empty($flagged[$id]))
				echo '
					<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>
						<dl class="settings">
							<dt>
								<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br />
								<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
							</dt>
							<dd>
								<strong>' . $txt['subforum_no_categories'] . '</strong>
							</dd>
						</dl>
					</div>';
		}
		echo '
					' . (count($subforum_tree) > 1 ? '</fieldset>' : '');
	}
	echo ']]></add>
	</operation>
	<operation>
		<search position="before"><![CDATA[function template_edit_group()
{
	global $context, $scripturl, $txt, $modSettings]]></search>
		<add><![CDATA[, $subforum_tree]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[if (!empty($context['categories']))
	{
		echo '
					<dt>
						<strong>', $txt['membergroups_new_board'], ':</strong>', $context['group']['is_post_group'] ? '<br>
						<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
					</dt>
					<dd>';
		if (!empty($context['can_manage_boards']))
			echo $txt['membergroups_can_manage_access'];
		else
			template_add_edit_group_boards_list();

		echo '
					</dd>';
	}
	echo '
				</dl>]]></search>
		<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	if (!empty($context['categories']))
	{
		$flagged = array( 0 => false );
		if (count($subforum_tree) > 1)
		{
			echo '
				</dl>
				<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
					function expandTabs(forum)
					{
						';
			foreach ($subforum_tree as $subforum => $info)
				echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
						document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
						';
			echo '
					}
				// ]]]]><![CDATA[></script>
				<fieldset id="visible_boards">
					<legend>', $txt['membergroups_new_board_desc'], '</legend>
					<div id="tabContainer">
						<div class="tabs">
							<ul>';
			foreach ($subforum_tree as $id => $section)
			{
				echo '
								<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
				$flagged[$id] = false;
			}
			echo '
							</ul>
						</div>
					</div>
					<hr class="hrcolor" />';
		}
		$context_categories = $context['categories'];
		foreach ($context_categories as $id => $categories)
		{
			echo '
					<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>
						<dl class="settings">
							<dt>
								<strong>', $txt['membergroups_new_board'], ':</strong>', $context['group']['is_post_group'] ? '<br>
								<span class="smalltext">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
							</dt>
							<dd>';
			if (!empty($context['can_manage_boards']))
				echo $txt['membergroups_can_manage_access'];
			else
			{
				$context['categories'] = $categories;
				template_add_edit_group_boards_list();
			}

			echo '
							</dd>
						</dl>
					</div>';
			$flagged[$id] = true;
		}
		foreach ($subforum_tree as $id => $section)
		{
			if ($flagged[$id] === false)
				echo '
					<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>
						<dl class="settings">
							<dt>
								<strong>', $txt['membergroups_new_board'], ':</strong>', $context['post_group'] ? '<br />
								<span class="smalltext" style="font-weight: normal">' . $txt['membergroups_new_board_post_groups'] . '</span>' : '', '
							</dt>
							<dd>
								<strong>' . $txt['subforum_no_categories'] . '</strong>
							</dd>
						</dl>
					</div>';
		}
		echo '
					' . (count($subforum_tree) > 1 ? '</fieldset>' : '');
	}
	echo '
					</dl>]]></add>
	</operation>
</file>
<file name="$themedir/ManagePermissions.template.php">
	<operation>
		<search position="before"><![CDATA[function template_by_board()
{
	global $context, $scripturl, $txt]]></search>
		<add><![CDATA[, $subforum_tree, $forumid]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[foreach ($context['categories'] as $category)
	{
		echo '
			<div class="sub_bar">
				<h3 class="subbg">', $category['name'], '</h3>
			</div>';

		if (!empty($category['boards']))
			echo '
				<ul class="perm_boards flow_hidden">';

		foreach ($category['boards'] as $board)
		{

			echo '
					<li class="flow_hidden">
						<span class="perm_board floatleft">
							<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
						</span>
						<span class="perm_boardprofile floatleft">';

			if ($context['edit_all'])
			{
				echo '
							<select name="boardprofile[', $board['id'], ']">';

				foreach ($context['profiles'] as $id => $profile)
					echo '
								<option value="', $id, '"', $id == $board['profile'] ? ' selected' : '', '>', $profile['name'], '</option>';

				echo '
							</select>';
			}
			else
				echo '
							<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '">', $board['profile_name'], '</a>';

			echo '
						</span>
					</li>';
		}

		if (!empty($category['boards']))
			echo '
				</ul>';
	}]]></search>
	<add><![CDATA[// Display the subforums as a tab at the top of the screen:
	$flagged = array( 0 => false );
	if (count($subforum_tree) > 1)
	{
		echo '
		<script type="text/javascript"><!-- // --><![CDATA[<]]><![CDATA[![CDATA[
			function expandTabs(forum)
			{
			';
	foreach ($subforum_tree as $subforum => $info)
		echo 'document.getElementById("subforum' . $subforum . '").style.display = (forum == ' . $subforum . ' ? "" : "none");
				document.getElementById("tab' . $subforum . '").className = (forum == ' . $subforum . ' ? "tabActiveHeader" : "");
				';
	echo '
			}
		// ]]]]><![CDATA[></script>
		<div id="tabContainer">
			<div class="tabs">
				<ul>';
		foreach ($subforum_tree as $id => $section)
		{
			echo '
					<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), ' id="tab' . $id . '"><a href="javascript:void(0);" onclick="expandTabs(' . $id . '); return false;">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';
			$flagged[$id] = false;
		}
		echo '
				</ul>
			</div>
		</div>
		<hr class="clear" />';
	}
	foreach ($context['categories'] as $id => $subforum)
	{
		echo '
		<div id="subforum' . $id . '"' . (!empty($id) ? ' style="display: none;"' : '') . '>';
	
		foreach ($subforum as $category)
		{
			echo '
			<div class="sub_bar">
				<h3 class="subbg">', $category['name'], '</h3>
			</div>';

			if (!empty($category['boards']))
				echo '
					<ul class="perm_boards flow_hidden">';

			foreach ($category['boards'] as $board)
			{
				echo '
						<li class="flow_hidden">
							<span class="perm_board floatleft">
								<a href="', $scripturl, '?action=admin;area=manageboards;sa=board;boardid=', $board['id'], ';rid=permissions;', $context['session_var'], '=', $context['session_id'], '">', str_repeat('-', $board['child_level']), ' ', $board['name'], '</a>
							</span>
							<span class="perm_boardprofile floatleft">';

				if ($context['edit_all'])
				{
					echo '
								<select name="boardprofile[', $board['id'], ']">';

					foreach ($context['profiles'] as $id => $profile)
						echo '
									<option value="', $id, '"', $id == $board['profile'] ? ' selected' : '', '>', $profile['name'], '</option>';

					echo '
								</select>';
				}
				else
					echo '
								<a href="', $scripturl, '?action=admin;area=permissions;sa=index;pid=', $board['profile'], ';', $context['session_var'], '=', $context['session_id'], '">', $board['profile_name'], '</a>';

				echo '
							</span>
						</li>';
			}

			if (!empty($category['boards']))
				echo '
					</ul>
				</div>
				<span class="botslice"><span></span></span>
			</div>';
		}
		$flagged[$id] = true;
		echo '
		</div>';
	}
	foreach ($flagged as $id => $flag)
	{
		if (!$flag)
			echo '
	<div id="subforum' . $id . '"' . ($context['req_forumid'] <> $id ? ' style="display: none;"' : '') . '>
	</div>';
	}]]></add>
	</operation>
</file>
</modification>