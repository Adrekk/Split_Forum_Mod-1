<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>Dougiefresh:Split_Forum</id>
<version>1.3</version>

<!-------------------------------------------------------------------------->
<!-- Some small changes to the Admin menu (Admin.php)                     -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Admin.php">
	<operation>	
		<search position="replace"><![CDATA['label' => $txt['subforums_list'],
					'file' => 'ManageSplitForums.php',
					'function' => 'ManageSplitForums',
					'icon' => 'server.gif',
					'subsections' => array(
						'main' => array($forumid != 0 ? $txt['subforum_modify_header'] : $txt['subforums_list'], 'admin_forum'),
						'newsub' => array($forumid != 0 ? '' : $txt['subforums_list_add'], 'admin_forum'),
						'settings' => array($txt['settings'], 'admin_forum'),]]></search>
		<add><![CDATA['label' => ($forumid != 0 ? $txt['subforum_modify_header'] : $txt['subforums_list']),
					'file' => 'ManageSplitForums.php',
					'function' => 'ManageSplitForums',
					'icon' => 'server.gif',
					'subsections' => array(
						'main' => array($forumid != 0 ? $txt['subforum_modify_header'] : $txt['subforums_list'], 'admin_forum'),
						'newsub' => array($txt['subforums_list_add'], 'admin_forum'),
						'settings' => array($txt['settings'], 'admin_forum'),]]></add>
	</operation>
	<operation>	
		<search position="replace"><![CDATA[unset($admin_areas['forum']['areas']['packages']);]]></search>
		<add><![CDATA[unset($admin_areas['forum']['areas']['packages']);
		unset($admin_areas['layout']['areas']['subforums']['subsections']['newsub']);
		unset($admin_areas['layout']['areas']['subforums']['subsections']['settings']);]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Replace subforum-location database calls (Load.php)                  -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Load.php">
	<operation>
		<search position="replace"><![CDATA[function reloadSettings()
{
	global $modSettings, $boarddir, $smcFunc, $txt, $db_character_set, $context, $sourcedir;
	global $boardurl, $cookiename, $boarddir, $forumid, $mbname, $subtheme, $language, $favicon;]]></search>
		<add><![CDATA[function reloadSettings()
{
	global $modSettings, $boarddir, $smcFunc, $txt, $db_character_set, $context, $sourcedir;
	global $boardurl, $cookiename, $boarddir, $forumid, $mbname, $subtheme, $language, $favicon, $subforum_tree;]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Determine which subforum we are in and load settings for it:
	$dir = $_SERVER['REQUEST_URI'];
	$dir = 'http://' . $_SERVER['HTTP_HOST'] . substr($dir, 0, strrpos($dir, '/'));
	$request = $smcFunc['db_query']('', '
		SELECT * FROM {db_prefix}subforums WHERE boardurl = "{raw:boardurl}" LIMIT 1',
		array(
			'boardurl' => $dir,
		)
	);
	if ($request)
	{
		$row = $smcFunc['db_fetch_assoc']($request);
		$smcFunc['db_free_result']($request);
	}
	if (!empty($row))
	{
		// Assign global variables with row gleaned from database:
		$forumid = $row['forumid'];
		$boardurl = $row['boardurl'];
		$forumdir = $row['forumdir'];
		$subtheme = $row['subtheme'];
		$mbname = $row['boardname'];
		$cookiename = $row['cookiename'];
		$language = $row['language'];
		$favicon = $row['favicon'];
		$modSettings['primary_membergroup'] = $row['primary_membergroup'];
	}
	else
    $forumid = 0;

	// UTF-8 in regular expressions is unsupported on PHP(win) versions < 4.2.3.]]></search>
		<add><![CDATA[// UTF-8 in regular expressions is unsupported on PHP(win) versions < 4.2.3.]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Most database systems have not set UTF-8 as their default input charset.]]></search>
		<add><![CDATA[// Define primary subforum entry if it is not already defined:
	global $cookiename, $boardurl, $mbname, $language, $boarddir;
	if (!is_array($subforum_tree))
		$subforum_tree = array(
			0 => array(		// Primary subforum
				'forumid' => 0,
				'cookiename' => $cookiename,
				'boardurl' => $boardurl,
				'boardname' => $mbname,
				'language' => $language,
				'forumdir' => $boarddir,
				'favicon' => '',
				'primary_membergroup' => 0,
				'subtheme' => 0,
			),
		);

	// Determine which subforum we are in and load settings for it:
	global $subforum_tree;
	$dir = $_SERVER['REQUEST_URI'];
	$dir = 'http://' . $_SERVER['HTTP_HOST'] . substr($dir, 0, strrpos($dir, '/'));
	if (!is_array($subforum_tree))
		$subforum_tree = array();
	foreach ($subforum_tree as $id => $row)
	{
		if ($row['boardurl'] == $dir)
		{
			// Assign global variables with row gleaned from database:
			$forumid = $row['forumid'];
			$boardurl = $row['boardurl'];
			$forumdir = $row['forumdir'];
			$subtheme = $row['subtheme'];
			$mbname = $row['boardname'];
			$cookiename = $row['cookiename'];
			$language = $row['language'];
			$favicon = $row['favicon'];
			$modSettings['primary_membergroup'] = $row['primary_membergroup'];
		}
	}

	// Most database systems have not set UTF-8 as their default input charset.]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[// Find the right subforum to redirect to:
				$request = $smcFunc['db_query']('', '
					SELECT boardurl FROM {db_prefix}subforums WHERE forumid = {int:forumid}',
					array( 'forumid' => (int) $row['forumid'] )
				);
				$sub = $smcFunc['db_fetch_assoc']($request);
				$smcFunc['db_free_result']($request);]]></search>
		<add><![CDATA[// Find the right subforum to redirect to:
				global $subforum_tree;
				$sub = (isset($subforum_tree[(int) $row['forumid']]) ? $subforum_tree[(int) $row['forumid']] : 0);]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Replace subforum adminstration database calls (Subs-Admin.php)       -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Subs-Admin.php">
	<operation>
		<search position="replace"><![CDATA[global $boarddir, $cachedir, $smcFunc, $forumid;

	// Put available data in the Split Forums database:
	if (isset($config_vars['mbname']))
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}subforums SET boardname = {raw:txt} WHERE forumid = ' . $forumid, 
			array('txt' => $config_vars['mbname']));
	if (isset($config_vars['boardurl']))
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}subforums SET boardurl = {raw:txt} WHERE forumid = ' . $forumid, 
			array('txt' => $config_vars['boardurl']));
	if (isset($config_vars['boardurl']))
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}subforums SET forumdir = {raw:txt} WHERE forumid = ' . $forumid, 
			array('txt' => $config_vars['boardurl']));
	if (isset($config_vars['cookiename']))
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}subforums SET cookiename = {raw:txt} WHERE forumid = ' . $forumid, 
			array('txt' => $config_vars['cookiename']));
	if (isset($config_vars['favicon']))
		$smcFunc['db_query']('', '
			UPDATE {db_prefix}subforums SET favicon = {raw:txt} WHERE forumid = ' . $forumid, 
			array('txt' => $config_vars['favicon']));
	unset($config_vars['favicon']);]]></search>
		<add><![CDATA[global $boarddir, $cachedir, $forumid, $subforum_tree;

	// Put available data in the Subforum Tree variable:
	if (isset($config_vars['mbname']))
		$subforum_tree[$forumid]['boardname'] = $config_vars['mbname'];
	if (isset($config_vars['boardurl']))
		$subforum_tree[$forumid]['boardurl'] = $config_vars['boardurl'];
	if (isset($config_vars['cookiename']))
		$subforum_tree[$forumid]['cookiename'] = $config_vars['cookiename'];
	if (isset($config_vars['favicon']))
		$subforum_tree[$forumid]['favicon'] = $config_vars['favicon'];
	unset($config_vars['favicon']);
	
	// Clear some variables if we are in a subforum:
	if ((isset($config_vars['mbname']) || isset($config_vars['boardurl']) || isset($config_vars['cookiename'])) && $forumid != 0)
	{
		unset($config_vars['mbname']);
		unset($config_vars['boardurl']);
		unset($config_vars['cookiename']);
	}]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Replace $subforum_tree variable building code (Subs-Boards.php)      -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/Subs-Boards.php">
	<operation>
		<search position="replace"><![CDATA[function getBoardTree($reqid = -1)
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc, $forumid, $subforum_tree;

	// Build the subforum tree array:
	$request = $smcFunc['db_query']('', '
		SELECT * FROM {db_prefix}subforums'.($forumid <> 0 ? ' WHERE forumid = {int:forumid}' : '').' ORDER BY forumid',
		array(
			'forumid' => (int) $forumid,
		)
	);
	$subforum_tree = array();
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		$subforum_tree[$row['forumid']] = $row;
	}
	$smcFunc['db_free_result']($request);
	
	// Getting all the board and category information you'd ever wanted.
	$reqid = (int) ($forumid == 0 ? (isset($_REQUEST['sub']) ? $_REQUEST['sub'] : $reqid) : $forumid);]]></search>
		<add><![CDATA[function getBoardTree($reqid = 0)
{
	global $cat_tree, $boards, $boardList, $txt, $modSettings, $smcFunc, $forumid, $subforum_tree;

	// Build the subforum tree array:
	if ($forumid <> 0)
		$subforum_tree = array($forumid => $subforum_tree[$forumid]);
	
	// Getting all the board and category information you'd ever wanted.
	$reqid = (int) ($forumid == 0 ? (isset($_REQUEST['sub']) ? $_REQUEST['sub'] : $reqid) : $forumid);]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		]]></search>
		<add><![CDATA[$cat_tree = array();
	$boards = array();
	$last_board_order = 0;
	while ($row = $smcFunc['db_fetch_assoc']($request))
	{
		if (!isset($subforum_tree[$row['forumid']]))
			$subforum_tree[$row['forumid']] = array('forumid' => (int) $row['forumid']);
			
		]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Support for listing undefined subforum (ManageBoards.template.php)   -->
<!-------------------------------------------------------------------------->
<file name="$themedir/ManageBoards.template.php">
	<operation>
		<search position="replace"><![CDATA[<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), '><a href="', $scripturl, '?action=admin;area=manageboards;sa=main;sub=', $id, '">', $section['boardname'], '</a></li>';]]></search>
		<add><![CDATA[<li', ($id == $context['req_forumid'] ? ' class="tabActiveHeader"' : ''), '><a href="', $scripturl, '?action=admin;area=manageboards;sa=main;sub=', $id, '">', (isset($section['boardname']) ? $section['boardname'] : '# '.$section['forumid']), '</a></li>';]]></add>
	</operation>
</file>

</modification>